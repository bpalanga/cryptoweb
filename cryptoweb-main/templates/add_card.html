<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Credit Card - Credit Card Vault</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .card-form {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        .form-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin: -30px -30px 30px -30px;
        }
        .card-preview {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        .card-input-group {
            position: relative;
        }
        .card-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
        }
        .visa-color { color: #1a1f71; }
        .mastercard-color { color: #eb001b; }
        .amex-color { color: #2e77bc; }
        .discover-color { color: #ff6000; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/dashboard">
                    <i class="fas fa-shield-alt"></i> Credit Vault
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/vault">
                                <i class="fas fa-credit-card"></i> Card Vault
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/invoices">
                                <i class="fas fa-file-invoice"></i> Invoices
                            </a>
                        </li>
                        {% if session.role in ['admin', 'merchant'] %}
                        <li class="nav-item">
                            <a class="nav-link" href="/create-invoice">
                                <i class="fas fa-plus-circle"></i> Create Invoice
                            </a>
                        </li>
                        {% endif %}
                        {% if session.role in ['admin', 'auditor'] %}
                        <li class="nav-item">
                            <a class="nav-link" href="/audit-logs">
                                <i class="fas fa-clipboard-list"></i> Audit Logs
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i> {{ session.full_name }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/profile">
                                    <i class="fas fa-user"></i> Profile
                                </a></li>
                                <li><a class="dropdown-item" href="/change-password">
                                    <i class="fas fa-key"></i> Change Password
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/logout">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'danger' else 'warning' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Card Form -->
        <div class="card-form">
            <div class="form-header">
                <h2><i class="fas fa-credit-card"></i> Add New Credit Card</h2>
                <p class="mb-0">Securely add a new credit card to your vault</p>
            </div>

            <!-- IMPORTANT: Make sure the form method is POST and action points to /add-card -->
            <form method="POST" action="/add-card" id="cardForm">
                <!-- Card Preview -->
                <div class="card-preview">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5><i class="fas fa-eye"></i> Card Preview</h5>
                            <div class="mb-2">
                                <strong>Card Number:</strong> 
                                <span id="previewNumber">#### #### #### ####</span>
                            </div>
                            <div class="mb-2">
                                <strong>Card Holder:</strong> 
                                <span id="previewHolder">JOHN DOE</span>
                            </div>
                            <div>
                                <strong>Expiry:</strong> 
                                <span id="previewExpiry">MM/YYYY</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <i class="fab fa-cc-visa fa-3x visa-color" id="previewLogo"></i>
                        </div>
                    </div>
                </div>

                <!-- Card Number -->
                <div class="mb-3">
                    <label for="card_number" class="form-label">
                        <i class="fas fa-credit-card"></i> Card Number
                    </label>
                    <div class="card-input-group">
                        <input type="text" class="form-control" id="card_number" name="card_number" 
                               placeholder="1234 5678 9012 3456" maxlength="19"
                               value="{% if card_data %}{{ card_data.number }}{% endif %}"
                               oninput="formatCardNumber()" required>
                        <div class="card-icon">
                            <i class="fab fa-cc-visa visa-color" id="cardLogo"></i>
                        </div>
                    </div>
                    <div class="form-text">Enter 13-19 digit card number. Spaces are automatically added.</div>
                </div>

                <div class="row">
                    <!-- CVV -->
                    <div class="col-md-3 mb-3">
                        <label for="cvv" class="form-label">
                            <i class="fas fa-lock"></i> CVV
                        </label>
                        <input type="password" class="form-control" id="cvv" name="cvv" 
                               placeholder="123" maxlength="4" 
                               value="{% if card_data %}{{ card_data.cvv }}{% endif %}"
                               required>
                        <div class="form-text">3-4 digit security code</div>
                    </div>

                    <!-- Card Holder -->
                    <div class="col-md-5 mb-3">
                        <label for="card_holder" class="form-label">
                            <i class="fas fa-user"></i> Card Holder Name
                        </label>
                        <input type="text" class="form-control" id="card_holder" name="card_holder" 
                               placeholder="JOHN DOE" 
                               value="{% if card_data %}{{ card_data.holder }}{% endif %}"
                               oninput="updatePreview()" required>
                        <div class="form-text">As printed on the card</div>
                    </div>

                    <!-- Card Type -->
                    <div class="col-md-4 mb-3">
                        <label for="card_type" class="form-label">
                            <i class="fas fa-credit-card"></i> Card Type
                        </label>
                        <select class="form-control" id="card_type" name="card_type" onchange="updateCardLogo()">
                            <option value="visa" {% if card_data and card_data.card_type == 'visa' %}selected{% endif %}>Visa</option>
                            <option value="mastercard" {% if card_data and card_data.card_type == 'mastercard' %}selected{% endif %}>MasterCard</option>
                            <option value="amex" {% if card_data and card_data.card_type == 'amex' %}selected{% endif %}>American Express</option>
                            <option value="discover" {% if card_data and card_data.card_type == 'discover' %}selected{% endif %}>Discover</option>
                            <option value="other" {% if card_data and card_data.card_type == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <!-- Expiry Month -->
                    <div class="col-md-3 mb-3">
                        <label for="expiry_month" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Expiry Month
                        </label>
                        <select class="form-control" id="expiry_month" name="expiry_month" oninput="updatePreview()" required>
                            <option value="">Month</option>
                            {% for month in range(1, 13) %}
                                <option value="{{ '%02d' % month }}" 
                                        {% if card_data and card_data.exp_month == '%02d'|format(month) %}selected{% endif %}>
                                    {{ '%02d' % month }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Expiry Year -->
                    <div class="col-md-3 mb-3">
                        <label for="expiry_year" class="form-label">
                            <i class="fas fa-calendar-alt"></i> Expiry Year
                        </label>
                        <select class="form-control" id="expiry_year" name="expiry_year" oninput="updatePreview()" required>
                            <option value="">Year</option>
                            {% for year in range(current_year, current_year + 11) %}
                                <option value="{{ year }}" {% if card_data and card_data.exp_year == year|string %}selected{% endif %}>
                                    {{ year }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Billing Address -->
                    <div class="col-md-6 mb-3">
                        <label for="billing_address" class="form-label">
                            <i class="fas fa-home"></i> Billing Address
                        </label>
                        <input type="text" class="form-control" id="billing_address" name="billing_address" 
                               placeholder="123 Main St, City, State, ZIP" 
                               value="{% if card_data %}{{ card_data.address }}{% endif %}"
                               required>
                    </div>
                </div>

                <!-- Security Note -->
                <div class="alert alert-info">
                    <i class="fas fa-shield-alt"></i>
                    <strong>Security Note:</strong> Your card information is encrypted and stored securely. 
                    We use industry-standard security measures to protect your data.
                </div>

                <!-- Form Buttons -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="/vault" class="btn btn-secondary btn-lg me-md-2">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> Save Card
                    </button>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <footer class="mt-5 text-center text-muted">
            <hr>
            <p>Credit Card Vault System &copy; 2024 | Role: {{ session.role|title }} | User: {{ session.userid }}</p>
        </footer>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Format card number with spaces
        function formatCardNumber() {
            let input = document.getElementById('card_number');
            let value = input.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formatted = '';
            
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            input.value = formatted;
            updatePreview();
        }

        // Update card logo based on card number or type
        function updateCardLogo() {
            const cardType = document.getElementById('card_type').value;
            const cardLogo = document.getElementById('cardLogo');
            const previewLogo = document.getElementById('previewLogo');
            
            // Remove all classes
            cardLogo.className = 'fab fa-3x';
            previewLogo.className = 'fab fa-3x';
            
            // Add appropriate classes
            if (cardType === 'visa') {
                cardLogo.classList.add('fa-cc-visa', 'visa-color');
                previewLogo.classList.add('fa-cc-visa', 'visa-color');
            } else if (cardType === 'mastercard') {
                cardLogo.classList.add('fa-cc-mastercard', 'mastercard-color');
                previewLogo.classList.add('fa-cc-mastercard', 'mastercard-color');
            } else if (cardType === 'amex') {
                cardLogo.classList.add('fa-cc-amex', 'amex-color');
                previewLogo.classList.add('fa-cc-amex', 'amex-color');
            } else if (cardType === 'discover') {
                cardLogo.classList.add('fa-cc-discover', 'discover-color');
                previewLogo.classList.add('fa-cc-discover', 'discover-color');
            } else {
                cardLogo.classList.add('fa-credit-card', 'text-secondary');
                previewLogo.classList.add('fa-credit-card', 'text-secondary');
            }
            
            updatePreview();
        }

        // Update preview section
        function updatePreview() {
            // Card Number
            const cardNumber = document.getElementById('card_number').value;
            const previewNumber = document.getElementById('previewNumber');
            if (cardNumber) {
                previewNumber.textContent = cardNumber;
            } else {
                previewNumber.textContent = '#### #### #### ####';
            }
            
            // Card Holder
            const cardHolder = document.getElementById('card_holder').value.toUpperCase();
            const previewHolder = document.getElementById('previewHolder');
            previewHolder.textContent = cardHolder || 'JOHN DOE';
            
            // Expiry
            const expiryMonth = document.getElementById('expiry_month').value;
            const expiryYear = document.getElementById('expiry_year').value;
            const previewExpiry = document.getElementById('previewExpiry');
            
            if (expiryMonth && expiryYear) {
                previewExpiry.textContent = expiryMonth + '/' + expiryYear;
            } else {
                previewExpiry.textContent = 'MM/YYYY';
            }
        }

        // Auto-detect card type from number
        document.getElementById('card_number').addEventListener('input', function(e) {
            const number = e.target.value.replace(/\s/g, '');
            
            if (number.startsWith('4')) {
                document.getElementById('card_type').value = 'visa';
            } else if (number.startsWith('5')) {
                document.getElementById('card_type').value = 'mastercard';
            } else if (number.startsWith('3')) {
                document.getElementById('card_type').value = 'amex';
            } else if (number.startsWith('6')) {
                document.getElementById('card_type').value = 'discover';
            }
            
            updateCardLogo();
        });

        // Form validation
        document.getElementById('cardForm').addEventListener('submit', function(e) {
            const cardNumber = document.getElementById('card_number').value.replace(/\s/g, '');
            const cvv = document.getElementById('cvv').value;
            const cardHolder = document.getElementById('card_holder').value;
            const billingAddress = document.getElementById('billing_address').value;
            
            // Basic validation
            if (cardNumber.length < 13 || cardNumber.length > 19) {
                e.preventDefault();
                alert('Card number must be between 13 and 19 digits');
                return false;
            }
            
            if (cvv.length < 3 || cvv.length > 4 || !/^\d+$/.test(cvv)) {
                e.preventDefault();
                alert('CVV must be 3-4 digits');
                return false;
            }
            
            if (!cardHolder.trim()) {
                e.preventDefault();
                alert('Card holder name is required');
                return false;
            }
            
            if (!billingAddress.trim()) {
                e.preventDefault();
                alert('Billing address is required');
                return false;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCardLogo();
            updatePreview();
            
            // If there's card_data from a previous submission, update the logo
            const cardTypeSelect = document.getElementById('card_type');
            if (cardTypeSelect.value) {
                updateCardLogo();
            }
        });
    </script>
</body>
</html>